---
tests:
  - name: discovery-no-tls
    pull_secret: $GITHUB_TOKEN
    deployments:
      - chart: topaz
        ports:
          8282: 8282
          8383: 8383
      - chart: discovery
        values: no-tls.values.yaml
        ports:
          18383: 8383
    secrets:
      - name: discovery-keys
        values:
          api-key: discovery-root-key
      - name: discovery-ghcr-token
        values:
          token: ghuser:$GITHUB_TOKEN
    run:
      - >
        ${TOPAZ:-topaz} ds set manifest charts/discovery/test/manifest.yaml
        -H localhost:8282 --plaintext
      - >
        ${TOPAZ:-topaz} ds import --directory charts/discovery/test/data
        -H localhost:8282 --plaintext
      - >
        curl http://localhost:18383/api/v1/info
      - >
        curl -H "Authorization:basic discovery-root-key" -H "aserto-tenant-id:4f71c224-e742-11ee-86df-00ba61ff9342"
        http://localhost:18383/api/v2/discovery/test-policy/test-policy/opa
    cleanup:
      - >
        exit 0
